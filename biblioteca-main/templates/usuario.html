<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Usuário - Acompanhamento de Ensaios</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='usuario.css') }}">
  <link rel="stylesheet" href="/static/css/relatorio.css">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
<header>
  <h1>Bem-vindo, {{ current_user.nome }}!</h1>
  <div class="botoes-header">
    <button id="btnAbrirMensagens" class="botao-mensagens">
      <i class="fa-solid fa-envelope-open-text"></i> Ver mensagens
    </button>
    <form action="{{ url_for('logout') }}" method="POST">
      <button type="submit" class="botao-logout">
        <i class="fa-solid fa-right-from-bracket"></i> Sair
      </button>
    </form>
  </div>
  

</header>

  <div class="botoes-esquerda">
    <button id="btnAbrirCalendario" class="botao-esquerda">
      <i class="fa-solid fa-calendar-days"></i> Ver ensaios
    </button>
    <button id="btnVerCultos" class="botao-esquerda">
      <i class="fa-solid fa-book-open"></i> Escala de cultos
    </button>
    <button id="btnMostrarMusicas" class="botao-esquerda">
      <i class="fa-solid fa-music"></i> Músicas para ensaio
    </button>

    
  </div>


  <div id="cardCalendario" class="card-calendario" style="display: none;">
    <h2>Selecione uma Data</h2>
    <input type="date" id="calendarioData">
    <button id="btnBuscarEscala" class="botao-aplicar"><i class="fa-solid fa-check"></i> Exibir Escala</button>
    <button id="btnFecharCalendario" class="botao-fechar"><i class="fa-solid fa-times"></i> Fechar</button>
  </div>

  <main id="areaEscalas" class="card-musica" style="display: none;">
    <h2>Escalados para ensaio <span id="dataSelecionada"></span></h2>
    <table>
      <thead>
        <tr>
          <th>Componente</th>
          <th>Horário</th>
          <th>Data</th>
        </tr>
      </thead>
      <tbody id="tabelaEscalas"></tbody>
    </table>
    <button id="btnMinimizarEscala" class="botao-minimizar">🔽 Minimizar Escala</button>
    <button onclick="imprimirEscala()">🖨️ Imprimir Escala</button>

    
  </main>


  <div id="areaMusicas" style="display: none;">
    <h2>Músicas Adicionadas pelos Cantores</h2>
    <button id="fecharMusicas" class="botao-fechar">
      <i class="fa-solid fa-times"></i> Fechar
    </button>
    <table>
      <thead>
        <tr>
          <th>Título</th>
          <th>Autor</th>
          <th>Gênero</th>
          <th>Tom</th>
          <th>Cantor</th>
          <th>Status</th>
          <th>Data de Ensaio</th>
        </tr>
      </thead>
      <tbody id="tabelaMusicas"></tbody>
    </table>
    <button onclick="abrirPaginaDeImpressao()">🖨️ Imprimir Músicas</button>
  </div>
  

  <div id="modalMensagens" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" id="fecharMensagens">&times;</span>
      <h3>📩 Caixa de Entrada</h3>
      <div id="listaMensagens" class="mensagens-lista"></div>
      <textarea id="novaMensagem" placeholder="Digite sua mensagem..."></textarea>
      <button id="btnEnviarMensagem">✉️ Enviar</button>
    </div>
  </div>

  
<div id="areaCultos" style="display: none;">
  <h2>📖 Cultos Agendados</h2>
  <button id="fecharCultos" class="botao-fechar">
    <i class="fa-solid fa-times"></i> Fechar
  </button>
  <div id="cartoesCultos" class="cartoes-container"></div>
</div>

  <div class="carrossel-banda">
    <div class="carrossel-container">
      <img src="{{ url_for('static', filename='imagens/integrante1.jpg') }}" alt="Integrante 1">
      <img src="{{ url_for('static', filename='imagens/integrante2.jpg') }}" alt="Integrante 2">
      <img src="{{ url_for('static', filename='imagens/integrante3.jpg') }}" alt="Integrante 3">
      <img src="{{ url_for('static', filename='imagens/integrante4.jpg') }}" alt="Integrante 4">
      <img src="{{ url_for('static', filename='imagens/integrante5.jpg') }}" alt="Integrante 5">
      <img src="{{ url_for('static', filename='imagens/integrante6.jpg') }}" alt="Integrante 6">
      <img src="{{ url_for('static', filename='imagens/integrante7.jpg') }}" alt="Integrante 7">
      <img src="{{ url_for('static', filename='imagens/integrante1.jpg') }}" alt="Integrante 1">
      <img src="{{ url_for('static', filename='imagens/integrante2.jpg') }}" alt="Integrante 2">
      <img src="{{ url_for('static', filename='imagens/integrante3.jpg') }}" alt="Integrante 3">
      <img src="{{ url_for('static', filename='imagens/integrante4.jpg') }}" alt="Integrante 4">
      <img src="{{ url_for('static', filename='imagens/integrante5.jpg') }}" alt="Integrante 5">
      <img src="{{ url_for('static', filename='imagens/integrante6.jpg') }}" alt="Integrante 6">
      <img src="{{ url_for('static', filename='imagens/integrante7.jpg') }}" alt="Integrante 7">
    </div>
  </div>
  
  <script>

// 📩 Mensagens
document.getElementById("btnAbrirMensagens").addEventListener("click", () => {
  document.getElementById("modalMensagens").style.display = "block";
  carregarMensagens();
});
document.getElementById("fecharMensagens").onclick = () => {
  document.getElementById("modalMensagens").style.display = "none";
};
function carregarMensagens() {
  fetch("/caixa_entrada")
    .then(res => res.json())
    .then(mensagens => {
      const lista = document.getElementById("listaMensagens");
      lista.innerHTML = mensagens.length === 0
        ? "<p style='text-align:center;'>📭 Nenhuma mensagem recebida.</p>"
        : mensagens.map(m => `<div class='mensagem resposta'><strong>${m.autor}</strong>: <span>${m.conteudo}</span><small>${m.data}</small></div>`).join("");
    });
}

document.getElementById("fecharMusicas").onclick = () => {
  document.getElementById("areaMusicas").style.display = "none";
};

document.getElementById("fecharCultos").onclick = () => {
  document.getElementById("areaCultos").style.display = "none";
};

document.getElementById("btnEnviarMensagem").onclick = () => {
  const conteudo = document.getElementById("novaMensagem").value.trim();
  if (!conteudo) return alert("⚠️ Digite uma mensagem antes de enviar!");
  fetch("/enviar_mensagem", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ conteudo })
  }).then(res => {
    if (res.ok) {
      document.getElementById("novaMensagem").value = "";
      alert("✅ Mensagem enviada com sucesso!");
      carregarMensagens();
    } else {
      alert("❌ Erro ao enviar mensagem.");
    }
  });
};

// 📆 Calendário de escalas
document.getElementById("btnAbrirCalendario").onclick = () =>
  document.getElementById("cardCalendario").style.display = "block";

document.getElementById("btnFecharCalendario").onclick = () =>
  document.getElementById("cardCalendario").style.display = "none";


document.getElementById("btnBuscarEscala").onclick = () => {
  const data = document.getElementById("calendarioData").value;
  if (!data) return alert("⚠️ Selecione uma data antes de buscar!");

  // Atualiza o botão PDF com a data selecionada
  const botaoPDF = document.getElementById("botao-exportar-pdf");
  botaoPDF.href = `/exportar_escala_pdf?data=${encodeURIComponent(data)}`;

  fetch(`/obter_escalas_por_data?data=${data}`)
    .then(res => res.json())
    .then(data => {
      const tabela = document.getElementById("tabelaEscalas");
      tabela.innerHTML = "";
      if (!data.escalas || data.escalas.length === 0) {
        tabela.innerHTML = `<tr><td colspan="3">📌 Nenhuma escala encontrada para esta data.</td></tr>`;
      } else {
        data.escalas.forEach(e => {
          tabela.innerHTML += `<tr><td>${e.componente}</td><td>${e.horario}</td><td>${e.dia}</td></tr>`;
        });
      }

      document.getElementById("dataSelecionada").textContent = data.data || data.dia || data;
      document.getElementById("areaEscalas").style.display = "block";
      document.getElementById("cardCalendario").style.display = "none";
    });
};



document.getElementById("btnMinimizarEscala").onclick = () => {
  const area = document.getElementById("areaEscalas");
  area.style.display = area.style.display === "block" ? "none" : "block";
};



// 🎵 Exibir músicas
document.getElementById("btnMostrarMusicas").onclick = () => {
  const area = document.getElementById("areaMusicas");
  if (area.style.display === "none" || area.style.display === "") {
    area.style.display = "block";
    fetch(`/obter_musicas`)
      .then(res => res.json())
      .then(data => {
        const tabela = document.getElementById("tabelaMusicas");
          musicasExibidas = data.musicas.map(m => ({
            titulo: m.titulo,
            autor: m.autor,
            genero: m.genero,
            tom: m.tom,
            status: m.ensaiada ? "Ensaiada" : "Não ensaiada",
            data_ensaio: m.data_ensaio,
            cantor: m.cantor
          }));

          tabela.innerHTML = musicasExibidas.map(m => `
            <tr>
              <td>${m.titulo}</td>
              <td>${m.autor}</td>
              <td>${m.genero}</td>
              <td>${m.tom}</td>
              <td>${m.cantor}</td>
              <td>${m.status}</td>
              <td>${m.data_ensaio}</td>
            </tr>`).join("");
      });
  } else {
    area.style.display = "none";
  }
};

// 📅 Cultos (versão cartões)
document.getElementById("btnVerCultos").addEventListener("click", () => {
  const container = document.getElementById("areaCultos");
  const visivel = container.style.display === "block";
  container.style.display = visivel ? "none" : "block";
  if (visivel) return;

  const cartoes = document.getElementById("cartoesCultos");
  cartoes.innerHTML = "";

  fetch("/cultos_usuario", {
    method: "GET",
    credentials: "same-origin"
  })
    .then(res => res.json())
    .then(cultos => {
      if (!cultos.length) {
        cartoes.innerHTML = "<p style='text-align:center;'>📭 Nenhum culto encontrado.</p>";
        return;
      }

      cultos.forEach(culto => {
        const musicas = culto.musicas.map(m => `<span class="tag">${m.titulo} (${m.tom})</span>`).join(" ");
        const escala = culto.escala.length
          ? culto.escala.map(e => `<li>${e}</li>`).join("")
          : "<li><em>Sem escala</em></li>";

        const card = document.createElement("div");
        card.className = "cartao-culto";
        card.innerHTML = `
          <h4>📅 Culto do dia ${culto.data}</h4>
          <p><strong>Músicas:</strong><br>${musicas}</p>
          <p><strong>Escala:</strong></p>
          <ul>${escala}</ul>
        `;
        cartoes.appendChild(card);
      });
    })
    .catch(err => {
      console.error("Erro ao buscar cultos:", err);
      alert("❌ Erro ao carregar cultos.");
    });
});


  function atualizarBotaoPDF(dataSelecionada) {
    const botao = document.getElementById('botao-exportar-pdf');
    botao.href = `/exportar_escala_pdf?data=${encodeURIComponent(dataSelecionada)}`;
  }


  let dataSelecionada = null;

  function abrirEscala(data) {
    dataSelecionada = data; // ✅ atualiza a variável global
    
    document.getElementById('dataSelecionada').textContent = data;
    document.getElementById('areaEscalas').style.display = 'block';

    // Atualiza o botão PDF também
    const botaoPDF = document.getElementById('botao-exportar-pdf');
    botaoPDF.href = `/exportar_escala_pdf?data=${encodeURIComponent(dataSelecionada)}`;
  }


  function abrirPDFMusicas() {
  window.open("/exportar_musicas_pdf", "_blank");
}

    let musicasExibidas = [];

    document.getElementById("btnMusicasParaEnsaio").onclick = () => {
      fetch("/obter_musicas")
        .then(res => res.json())
        .then(data => {
          if (!data.musicas || data.musicas.length === 0) {
            musicasExibidas = [];
            document.getElementById("tabelaMusicas").innerHTML = `<tr><td colspan="7">📌 Nenhuma música adicionada pelos cantores.</td></tr>`;
            return;
          }

          // ✅ Reformatar os dados para o PDF
          musicasExibidas = data.musicas.map(m => ({
            titulo: m.titulo,
            autor: m.autor,
            genero: m.genero,
            tom: m.tom,
            status: m.ensaiada ? "Ensaiada" : "Não ensaiada",
            data_ensaio: m.data_ensaio,
            cantor: m.cantor
          }));

          const tabela = document.getElementById("tabelaMusicas");
          tabela.innerHTML = "";
          musicasExibidas.forEach(m => {
            tabela.innerHTML += `
              <tr>
                <td>${m.titulo}</td>
                <td>${m.autor}</td>
                <td>${m.genero}</td>
                <td>${m.tom}</td>
                <td>${m.cantor}</td>
                <td>${m.status}</td>
                <td>${m.data_ensaio}</td>
              </tr>`;
          });

          document.getElementById("areaMusicas").style.display = "block";
        });
    };

    function exportarMusicasPDF() {
      if (musicasExibidas.length === 0) {
        alert("⚠️ Nenhuma música carregada para exportar.");
        return;
      }

      fetch("/gerar_pdf_musicas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ musicas: musicasExibidas })
      })
      .then(res => res.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        window.open(url, "_blank");
      });
    }

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>


<script>
  function exportarEscalaPDF() {
    const bloco = document.getElementById('areaEscalas');
    if (!bloco || bloco.style.display === 'none') {
      alert("A escala precisa estar visível para exportar.");
      return;
    }

    const opt = {
      margin: 10,
      filename: 'escala.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(bloco).save();
  }
</script>

<script>
function abrirPaginaDeImpressao() {
  const tabela = document.getElementById('tabelaMusicas');
  if (!tabela || tabela.innerHTML.trim() === '') {
    alert("Nenhuma música disponível para imprimir.");
    return;
  }

  const estiloCSS = `
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 30px;
      background-color: #fff;
      color: #222;
    }
    h2 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px 12px;
      border: 1px solid #ccc;
      text-align: left;
      font-size: 15px;
    }
    th {
      background-color: #34495e;
      color: #ecf0f1;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tbody tr:hover {
      background-color: #f1f1f1;
    }
  `;

  const janela = window.open('', '_blank');
  janela.document.write(`
    <html>
      <head>
        <title>Relatório de Músicas</title>
        <style>${estiloCSS}</style>
      </head>
      <body>
        <h2>Músicas Adicionadas pelos Cantores</h2>
        <table>
          <thead>
            <tr>
              <th>Título</th>
              <th>Autor</th>
              <th>Gênero</th>
              <th>Tom</th>
              <th>Cantor</th>
              <th>Status</th>
              <th>Data de Ensaio</th>
            </tr>
          </thead>
          <tbody>
            ${tabela.innerHTML}
          </tbody>
        </table>

        <footer style="margin-top: 40px; text-align: center; font-size: 14px; color: #555;">
          Gerado por <strong>Repertório Online</strong>
        </footer>
        
        <script>
          window.onload = function() {
            window.print();
          };
        <\/script>
      </body>
    </html>
  `);
  janela.document.close();
}

document.getElementById("btnBuscarEscala").onclick = () => {
  const data = document.getElementById("calendarioData").value;
  if (!data) return alert("⚠️ Selecione uma data antes de buscar!");

  fetch(`/obter_escalas_por_data?data=${data}`)
    .then(res => res.json())
    .then(data => {
      const tabela = document.getElementById("tabelaEscalas");
      tabela.innerHTML = "";
      if (!data.escalas || data.escalas.length === 0) {
        tabela.innerHTML = `<tr><td colspan="3">📌 Nenhuma escala encontrada para esta data.</td></tr>`;
      } else {
        data.escalas.forEach(e => {
          tabela.innerHTML += `<tr><td>${e.componente}</td><td>${e.horario}</td><td>${e.dia}</td></tr>`;
        });
      }

      document.getElementById("dataSelecionada").textContent = data.data || data.dia || data;
      document.getElementById("areaEscalas").style.display = "block";
      document.getElementById("cardCalendario").style.display = "none";
      
    });
};

function imprimirEscala() {
  const tabela = document.getElementById('tabelaEscalas');
  if (!tabela || tabela.innerHTML.trim() === '') {
    alert("Nenhuma escala disponível para imprimir.");
    return;
  }

  const estiloCSS = `
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 30px;
      background-color: #fff;
      color: #222;
    }
    h2 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px 12px;
      border: 1px solid #ccc;
      text-align: left;
      font-size: 15px;
    }
    th {
      background-color: #34495e;
      color: #ecf0f1;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tbody tr:hover {
      background-color: #f1f1f1;
    }
  `;

  const janela = window.open('', '_blank');
  janela.document.write(`
    <html>
      <head>
        <title>Escala de Ensaio</title>
        <style>${estiloCSS}</style>
      </head>
      <body>
        <h2>Escala de Ensaio</h2>
        <table>
          <thead>
            <tr>
              <th>Componente</th>
              <th>Horário</th>
              <th>Data</th>
            </tr>
          </thead>
          <tbody>
            ${tabela.innerHTML}
          </tbody>
        </table>

        <footer style="margin-top: 40px; text-align: center; font-size: 14px; color: #555;">
          Gerado por <strong>Repertório Online</strong>
        </footer>

        <script>
          window.onload = function() {
            window.print();
          };
        <\/script>
      </body>
    </html>
  `);
  janela.document.close();
}
</script>
</body>
</html>