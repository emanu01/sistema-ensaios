<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Usu√°rio - Acompanhamento de Ensaios</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='usuario.css') }}">
  <link rel="stylesheet" href="/static/css/relatorio.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>
<body>

<header class="container-fluid bg-light py-3 text-center">
  <div class="logo-central mb-3">
    <img src="{{ url_for('static', filename='imagens/logo.png') }}" alt="Logo_Play_Repert√≥rio" />
    <h1 class="mb-3 fs-4 fs-md-3">Bem-vindo, {{ current_user.nome }}!</h1>
  </div>

  <div class="d-flex flex-column flex-md-row justify-content-center align-items-center gap-2">
    <div>
      <button id="btnAbrirMensagens" class="btn btn-outline-primary">
        <i class="fa-solid fa-envelope-open-text"></i> Ver mensagens
      </button>
    </div>
    <div>
      <form action="{{ url_for('logout') }}" method="POST">
        <button type="submit" class="btn btn-outline-danger">
          <i class="fa-solid fa-right-from-bracket"></i> Sair
        </button>
      </form>
    </div>
  </div>
</header>

<div class="container my-4">
  <button id="btnToggleMenu" class="btn btn-outline-light mb-3">
    <i class="fa-solid fa-bars"></i> Abrir menu
  </button>

  <div id="menuAcoes" style="display: none;" class="d-flex flex-column gap-3 mb-4 w-100">
    <button id="btnAbrirCalendario" class="btn btn-outline-secondary w-100" style="display: none;">
      <i class="fa-solid fa-calendar-days"></i> Ver ensaios
    </button>

    <button id="btnVerCultos" class="btn btn-outline-secondary w-100" style="display: none;">
      <i class="fa-solid fa-book-open"></i> Escala de cultos
    </button>

    <button id="btnMostrarMusicas" class="btn btn-outline-secondary w-100" style="display: none;">
      <i class="fa-solid fa-music"></i> M√∫sicas para ensaio
    </button>
  </div>
</div>

<!-- Calend√°rio escondido -->
<div id="cardCalendario" class="card p-4 mb-4" style="display: none;">
  <h2>üìÖ Selecione uma data para ver a escala</h2>
  <input type="date" id="calendarioData" class="form-control mb-3">
  <div class="d-flex justify-content-center gap-3">
    <button id="btnBuscarEscala" class="btn btn-success">üîç Buscar Escala</button>
    <button id="btnFecharCalendario" class="btn btn-danger">‚ùå Fechar</button>
  </div>
</div>

<main id="areaEscalas" class="card p-4 mb-4" style="display: none;">
  <h2>Escalados para ensaio <span id="dataSelecionada"></span></h2>
  <div class="table-responsive">
    <table class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>Componente</th>
          <th>Hor√°rio</th>
          <th>Data</th>
        </tr>
      </thead>
      <tbody id="tabelaEscalas"></tbody>
    </table>
  </div>
  <div class="d-flex justify-content-center flex-wrap gap-3 mt-3">
    <button id="btnMinimizarEscala" class="btn btn-warning">üîΩ Minimizar Escala</button>
    <button id="btnImprimirEscala" onclick="imprimirEscala()" class="btn btn-info">üñ®Ô∏è Imprimir Escala</button>
  </div>
</main>

<div id="areaMusicas" class="card p-4 mb-4" style="display: none;">
  <h2>M√∫sicas Adicionadas pelos Cantores</h2>
  <div class="table-responsive">
    <table class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>T√≠tulo</th>
          <th>Autor</th>
          <th>G√™nero</th>
          <th>Tom</th>
          <th>Cantor</th>
          <th>Status</th>
          <th>Data de Ensaio</th>
        </tr>
      </thead>
      <tbody id="tabelaMusicas"></tbody>
    </table>
  </div>
  <div class="text-center my-3">
    <button id="btnImprimirMusicas" onclick="abrirPaginaDeImpressao()" class="btn btn-info">üñ®Ô∏è Imprimir M√∫sicas</button>
  </div>
</div>

<div id="areaCultos" class="card p-4 mb-4" style="display: none;">
  <h2>üìñ Cultos Agendados</h2>
  <div id="cartoesCultos" class="cartoes-container"></div>
</div>

<div class="container my-4">
  <div class="carrossel-banda overflow-auto">
    <div class="d-flex flex-nowrap gap-3 carrossel-container">
      <img src="{{ url_for('static', filename='imagens/integrante1.jpg') }}" alt="Integrante 1" class="img-fluid rounded">
      <img src="{{ url_for('static', filename='imagens/integrante2.jpg') }}" alt="Integrante 2" class="img-fluid rounded">
      <img src="{{ url_for('static', filename='imagens/integrante3.jpg') }}" alt="Integrante 3" class="img-fluid rounded">
      <img src="{{ url_for('static', filename='imagens/integrante4.jpg') }}" alt="Integrante 4" class="img-fluid rounded">
      <img src="{{ url_for('static', filename='imagens/integrante5.jpg') }}" alt="Integrante 5" class="img-fluid rounded">
      <img src="{{ url_for('static', filename='imagens/integrante6.jpg') }}" alt="Integrante 6" class="img-fluid rounded">
      <img src="{{ url_for('static', filename='imagens/integrante7.jpg') }}" alt="Integrante 7" class="img-fluid rounded">
    </div>
  </div>
</div>

<!-- Modal de mensagens -->
<div id="modalMensagens" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">üì© Caixa de Entrada</h3>
        <span class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></span>
      </div>
      <div id="listaMensagens" class="mensagens-lista mb-3"></div>
      <textarea id="novaMensagem" class="form-control mb-3" placeholder="Digite sua mensagem..."></textarea>
      <button id="btnEnviarMensagem" class="btn btn-primary w-100">‚úâÔ∏è Enviar</button>
    </div>
  </div>
</div>

<!-- Scripts externos -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Fun√ß√µes de impress√£o -->
<script>
  function exportarEscalaPDF() {
    const bloco = document.getElementById('areaEscalas');
    if (!bloco || bloco.style.display === 'none') {
      alert("A escala precisa estar vis√≠vel para exportar.");
      return;
    }

    const opt = {
      margin: 10,
      filename: 'escala.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(bloco).save();
  }

  function abrirPaginaDeImpressao() {
    const tabela = document.getElementById('tabelaMusicas');
    if (!tabela || tabela.innerHTML.trim() === '') {
      alert("Nenhuma m√∫sica dispon√≠vel para imprimir.");
      return;
    }

    const estiloCSS = `
      body {
        font-family: 'Segoe UI', Arial, sans-serif;
        padding: 30px;
        background-color: #fff;
        color: #222;
      }
      h2 {
        text-align: center;
        font-size: 24px;
        margin-bottom: 20px;
        color: #2c3e50;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      th, td {
        padding: 10px 12px;
        border: 1px solid #ccc;
        text-align: left;
        font-size: 15px;
      }
      th {
        background-color: #34495e;
        color: #ecf0f1;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      tbody tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      tbody tr:hover {
        background-color: #f1f1f1;
      }
    `;

    const janela = window.open('', '_blank');
    janela.document.write(`
      <html>
        <head>
          <title>Relat√≥rio de M√∫sicas</title>
          <style>${estiloCSS}</style>
        </head>
        <body>
          <h2>M√∫sicas Adicionadas pelos Cantores</h2>
          <table>
            <thead>
              <tr>
                <th>T√≠tulo</th>
                <th>Autor</th>
                <th>G√™nero</th>
                <th>Tom</th>
                <th>Cantor</th>
                <th>Status</th>
                <th>Data de Ensaio</th>
              </tr>
            </thead>
            <tbody>
              ${tabela.innerHTML}
            </tbody>
          </table>
          <footer style="margin-top: 40px; text-align: center; font-size: 14px; color: #555;">
            Gerado por <strong>Repert√≥rio Online</strong>
          </footer>
          <script>
            window.onload = function() {
              window.print();
            };
          <\/script>
        </body>
      </html>
    `);
    janela.document.close();
  }

  function imprimirEscala() {
    const tabela = document.getElementById('tabelaEscalas');
    if (!tabela || tabela.innerHTML.trim() === '') {
      alert("Nenhuma escala dispon√≠vel para imprimir.");
      return;
    }

    const estiloCSS = `
      body {
        font-family: 'Segoe UI', Arial, sans-serif;
        padding: 30px;
        background-color: #fff;
        color: #222;
      }
      h2 {
        text-align: center;
        font-size: 24px;
        margin-bottom: 20px;
        color: #2c3e50;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      th, td {
        padding: 10px 12px;
        border: 1px solid #ccc;
        text-align: left;
        font-size: 15px;
      }
      th {
        background-color: #34495e;
        color: #ecf0f1;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      tbody tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      tbody tr:hover {
        background-color: #f1f1f1;
      }
    `;

    const janela = window.open('', '_blank');
    janela.document.write(`
      <html>
        <head>
          <title>Escala de Ensaio</title>
          <style>${estiloCSS}</style>
        </head>
        <body>
          <h2>Escala de Ensaio</h2>
          <table>
            <thead>
              <tr>
                <th>Componente</th>
                <th>Hor√°rio</th>
                <th>Data</th>
              </tr>
            </thead>
            <tbody>
              ${tabela.innerHTML}
            </tbody>
          </table>
          <footer style="margin-top: 40px; text-align: center; font-size: 14px; color: #555;">
            Gerado por <strong>Repert√≥rio Play</strong>
          </footer>
          <script>
            window.onload = function() {
              window.print();
            };
          <\/script>
        </body>
      </html>
    `);
    janela.document.close();
  }
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  function safeClick(id, callback) {
    const el = document.getElementById(id);
    if (el) el.addEventListener("click", callback);
  }

  // Abrir/Fechar menu
  safeClick("btnToggleMenu", () => {
    const btnAbrirCalendario = document.getElementById("btnAbrirCalendario");
    const btnVerCultos = document.getElementById("btnVerCultos");
    const btnMostrarMusicas = document.getElementById("btnMostrarMusicas");
    const btnToggleMenu = document.getElementById("btnToggleMenu");

    if (!btnAbrirCalendario || !btnVerCultos || !btnMostrarMusicas || !btnToggleMenu) return;

    const visivel = btnAbrirCalendario.style.display !== "none";
    const novoDisplay = visivel ? "none" : "inline-block";

    btnAbrirCalendario.style.display = novoDisplay;
    btnVerCultos.style.display = novoDisplay;
    btnMostrarMusicas.style.display = novoDisplay;

    btnToggleMenu.innerHTML = visivel
      ? '<i class="fa-solid fa-bars"></i> Abrir menu'
      : '<i class="fa-solid fa-xmark"></i> Fechar menu';
  });

  // Abrir modal de mensagens
  safeClick("btnAbrirMensagens", () => {
    const modal = new bootstrap.Modal(document.getElementById("modalMensagens"));
    modal.show();
    fetch("/mensagens")
      .then(res => res.json())
      .then(mensagens => {
        const lista = document.getElementById("listaMensagens");
        lista.innerHTML = "";
        if (!mensagens.length) {
          lista.innerHTML = `<div class="mensagem"><strong>Sistema:</strong><br><small>üì≠ Nenhuma mensagem encontrada.</small></div>`;
          return;
        }
        mensagens.forEach(msg => {
          lista.innerHTML += `
            <div class="mensagem">
              <strong>${msg.autor}</strong><br>
              <small>${msg.conteudo}</small><br>
              <small><em>${msg.data}</em></small>
            </div>
          `;
        });
        lista.scrollTop = lista.scrollHeight;
      });
  });

  // Enviar mensagem
  safeClick("btnEnviarMensagem", () => {
    const conteudo = document.getElementById("novaMensagem").value.trim();
    if (!conteudo) return alert("‚ö†Ô∏è Digite uma mensagem antes de enviar!");
    fetch("/enviar_mensagem", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ conteudo })
    }).then(res => {
      if (res.ok) {
        document.getElementById("novaMensagem").value = "";
        alert("‚úÖ Mensagem enviada com sucesso!");
        const modal = bootstrap.Modal.getInstance(document.getElementById("modalMensagens"));
        if (modal) modal.hide();
      } else {
        alert("‚ùå Erro ao enviar mensagem.");
      }
    });
  });

  // Ver ensaios (abrir calend√°rio)
  safeClick("btnAbrirCalendario", () => {
    const card = document.getElementById("cardCalendario");
    if (card) card.style.display = "block";
  });

  // Fechar calend√°rio
  safeClick("btnFecharCalendario", () => {
    const card = document.getElementById("cardCalendario");
    if (card) card.style.display = "none";
  });

  // Buscar escala
  safeClick("btnBuscarEscala", () => {
    const data = document.getElementById("calendarioData")?.value;
    if (!data) return alert("‚ö†Ô∏è Selecione uma data antes de buscar!");
    fetch(`/obter_escalas_por_data?data=${data}`)
      .then(res => res.json())
      .then(data => {
        const tabela = document.getElementById("tabelaEscalas");
        if (!tabela) return;
        tabela.innerHTML = "";
        if (!data.escalas?.length) {
          tabela.innerHTML = `<tr><td colspan="3">üìå Nenhuma escala encontrada para esta data.</td></tr>`;
        } else {
          data.escalas.forEach(e => {
            tabela.innerHTML += `<tr><td>${e.componente}</td><td>${e.horario}</td><td>${e.dia}</td></tr>`;
          });
        }
        document.getElementById("dataSelecionada").textContent = data.data_formatada || "";
        document.getElementById("areaEscalas").style.display = "block";
        document.getElementById("cardCalendario").style.display = "none";
      });
  });

  // Minimizar escala
  safeClick("btnMinimizarEscala", () => {
    const area = document.getElementById("areaEscalas");
    if (area) area.style.display = area.style.display === "block" ? "none" : "block";
  });

  // Mostrar m√∫sicas
  safeClick("btnMostrarMusicas", () => {
    const area = document.getElementById("areaMusicas");
    if (!area) return;
    const visivel = area.style.display === "block";
    area.style.display = visivel ? "none" : "block";
    if (!visivel) {
      fetch("/obter_musicas")
        .then(res => res.json())
        .then(data => {
          const tabela = document.getElementById("tabelaMusicas");
          if (!tabela) return;
          tabela.innerHTML = data.musicas.map(m => `
            <tr>
              <td>${m.titulo}</td>
              <td>${m.autor}</td>
              <td>${m.genero}</td>
              <td>${m.tom}</td>
              <td>${m.cantor}</td>
              <td>${m.ensaiada ? "Ensaiada" : "N√£o ensaiada"}</td>
              <td>${m.data_ensaio}</td>
            </tr>`).join("");
        });
    }
  });

  // Ver cultos
  safeClick("btnVerCultos", () => {
    const container = document.getElementById("areaCultos");
    if (!container) return;
    const visivel = container.style.display === "block";
    container.style.display = visivel ? "none" : "block";
    if (visivel) return;

    const cartoes = document.getElementById("cartoesCultos");
    if (!cartoes) return;
    cartoes.innerHTML = "";

    fetch("/cultos_usuario")
      .then(res => res.json())
      .then(cultos => {
        if (!cultos.length) {
          cartoes.innerHTML = "<p style='text-align:center;'>üì≠ Nenhum culto encontrado.</p>";
          return;
        }
        cultos.forEach(culto => {
          const musicas = culto.musicas.map(m => `<span class="tag">${m.titulo} (${m.tom})</span>`).join(" ");
          const escala = culto.escala.length
            ? culto.escala.map(e => `<li>${e}</li>`).join("")
            : "<li><em>Sem escala</em></li>";
          const card = document.createElement("div");
          card.className = "cartao-culto";
          card.innerHTML = `
            <h4>üìÖ Culto do dia ${culto.data}</h4>
            <p><strong>M√∫sicas:</strong><br>${musicas}</p>
            <p><strong>Escala:</strong></p>
            <ul>${escala}</ul>
          `;
          cartoes.appendChild(card);
        });
      });
  });
});
</script>
</body>
</html>