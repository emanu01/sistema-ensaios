<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Usuário - Acompanhamento de Ensaios</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='musicas.css') }}" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
  <style>
    @media print {
      .botao-voltar,
      .botao-adicionar,
      .acoes,
      .botao-imprimir,
      form,
      .mensagem-flash {
        display: none !important;
      }

      body * {
        visibility: hidden;
      }

      #area-impressao, #area-impressao * {
        visibility: visible;
      }

      #area-impressao {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>


  <header>
    <h1 class="efeito-aproximacao">🎶 Olá, Bem-vindo(a) {{ current_user.username }}</h1>
  </header>

  <div class="botoes-wrapper">
    <a href="{{ url_for('escala') }}" class="botao-escala"><i class="fa-solid fa-calendar-alt"></i> Ir para Escalas</a>
    {% if current_user.role == "admin" %}
    <a href="{{ url_for('gerenciar_usuarios') }}" class="botao-gerenciar"><i class="fa-solid fa-users"></i> Gerenciar Usuários</a>
    {% endif %}
    {% if current_user.role == "admin" %}
      <button id="btnAbrirSolicitacoes" class="botao-gerenciar" style="background-color: #f39c12;">
        👥 Ver solicitações de cadastro
      </button>
      <div id="areaSolicitacoes" style="display:none; margin-top: 20px;"></div>
    {% endif %}
    <a href="{{ url_for('cultos') }}" class="botao-ver-cultos">📖 Ver Cultos Agendados</a>
    <button id="btnAbrirMensagens" class="botao-mensagens">💬 Mensagens</button>
    <a href="{{ url_for('logout') }}" class="botao-sair"><i class="fas fa-sign-out-alt"></i> Sair</a> 
  </div>



<!-- Modal de Mensagens -->
<div id="modalMensagens" class="modal-mensagens" style="display:none;">
    <div class="modal-content">
      <span class="close" id="fecharMensagens">&times;</span>
      <h3>📩 Caixa de Entrada</h3>

      <div id="listaMensagens">
        <!-- Exemplo de mensagem -->
        <div class="mensagem-item">
          <span class="usuario">Emanuel:</span>
          <span class="texto">Essa música já foi ensaiada com o grupo.</span>
        </div>
      </div>

      <textarea id="novaMensagem" placeholder="Digite sua mensagem..."></textarea>
      <button id="btnEnviarMensagem">✉️ Enviar</button>
    </div>
  </div>

  <!-- Modal de Solicitações de Cadastro -->
  <div id="modalSolicitacoes" class="modal-solicitacoes" style="display:none;">
    <div class="modal-content">
      <span class="close" id="fecharSolicitacoes">&times;</span>
      <h3>Solicitações de Cadastro</h3>
      <div id="listaSolicitacoes">
        <p>🔄 Carregando solicitações...</p>
      </div>
    </div>
  </div>

  <!-- Modal de Calendário -->
  <div id="modalCalendario" class="modal-calendario" style="display:none;">
    <div class="modal-content">
      <span class="close" id="fecharModal">&times;</span>
      <h3>📅 Selecionar Data de Ensaio</h3>
      <input type="date" id="inputDataEnsaio">
      <button id="btnSalvarData">✅ Salvar</button>
    </div>
  </div>



<div id="cardMusicas">
  {% if musicas %}
      <form id="formMusicas">
        <div class="tabela-container">
         <table class="tabela">
          <thead>
            <tr>
              <th>Título</th>
              <th>Autor</th>
              <th>Tom</th>
              <th>Gênero</th>
              <th>Ensaiada?</th>
              {% if current_user.role in ["cantor", "admin"] %}
                <th>Ação</th>
                <th>Data do Ensaio</th>
              {% endif %}
              <th>Adicionada por</th>
            </tr>
          </thead>
          <tbody id="tabelaMusicas">
            {% for musica in musicas %}
            <tr>
              <td>{{ musica.titulo }}</td>
              <td>{{ musica.autor }}</td>
              <td>{{ musica.tom }}</td>
              <td>{{ musica.genero }}</td>
              <td>
                <input type="checkbox" name="status_{{ musica.musica_id }}" {% if musica.ensaiada %}checked{% endif %}>
              </td>
              {% if current_user.role in ["cantor", "admin"] %}
              <td>
                <button type="submit"
                        formaction="{{ url_for('excluir_musica', musica_id=musica.musica_id) }}"
                        formmethod="POST"
                        class="botao-excluir">
            ❌ Excluir
                </button>
              </td>
              <td>
                <button type="button" class="btnCalendario" data-id="{{ musica.musica_id }}">
            📅 {{ musica.data_ensaio.strftime('%d/%m/%Y') if musica.data_ensaio else '' }}
                </button>
              </td>
              {% endif %}
              <td>{{ musica.usuario.nome if musica.usuario else "Desconhecido" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>


      <!-- Área de impressão -->
      <div id="area-impressao" style="display: none;">
        <h2>🎼 Músicas Ensaiadas</h2>
        <table class="tabela">
          <thead>
            <tr>
              <th>Título</th>
              <th>Autor</th>
              <th>Tom</th>
            </tr>
          </thead>
          <tbody>
            {% for musica in musicas if musica.ensaiada %}
            <tr>
              <td>{{ musica.titulo }}</td>
              <td>{{ musica.autor }}</td>
              <td>{{ musica.tom }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <h2 style="margin-top: 40px;">🎯 Músicas a Ensaiar</h2>
        <table class="tabela">
          <thead>
            <tr>
              <th>Título</th>
              <th>Autor</th>
              <th>Tom</th>
            </tr>
          </thead>
          <tbody>
            {% for musica in musicas if not musica.ensaiada %}
            <tr>
              <td>{{ musica.titulo }}</td>
              <td>{{ musica.autor }}</td>
              <td>{{ musica.tom }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p>📌 Nenhuma música cadastrada no momento.</p>
    {% endif %}
  </div>

    <!-- ✅ Botão sempre visível -->
    <div class="centraliza-botao-wrapper">
      <button id="btnAbrirModalAdicionarMusica" class="botao-adicionar-musica" type="button">
        ➕ Adicionar Nova Música
      </button>
    </div>

  <div class="duas-listas">
    <!-- Bloco: Músicas Ensaiadas -->
    <div class="lista-cards">
      <h2>🎼 Músicas Ensaiadas</h2>
      {% for musica in musicas %}
        {% if musica.ensaiada %}
        <div class="card-musica ensaiada" data-id="{{ musica.musica_id }}">
          <div class="card-header">
            <i class="fa-solid fa-check-circle"></i>
            <strong>{{ musica.titulo }}</strong>
          </div>
          <div class="card-body">
            <p><strong>Autor:</strong> {{ musica.autor }}</p>
            <p><strong>Tom:</strong> {{ musica.tom }}</p>
          </div>
        </div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- Bloco: Músicas a Ensaiar -->
    <div class="lista-cards">
      <h2>🎯 Músicas a Ensaiar</h2>
      {% for musica in musicas %}
        {% if not musica.ensaiada %}
        <div class="card-musica a-ensaiar" data-id="{{ musica.musica_id }}">
          <div class="card-header">
            <i class="fa-solid fa-music"></i>
            <strong>{{ musica.titulo }}</strong>
          </div>
          <div class="card-body">
            <p><strong>Autor:</strong> {{ musica.autor }}</p>
            <p><strong>Tom:</strong> {{ musica.tom }}</p>
          </div>
        </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

      <div style="margin-top: 20px;">
        <button onclick="imprimirMusicas()" type="button" class="botao-imprimir">🖨️ Imprimir Músicas</button>
      </div>
    </div>
  </div>
  <script>
    let musicaSelecionada = null;

    // 📩 Mensagens
    document.getElementById("btnAbrirMensagens").addEventListener("click", () => {
      document.getElementById("modalMensagens").style.display = "block";
      carregarMensagens();
    });

    document.getElementById("fecharMensagens").addEventListener("click", () => {
      document.getElementById("modalMensagens").style.display = "none";
    });

    document.getElementById("btnEnviarMensagem").addEventListener("click", () => {
      const conteudo = document.getElementById("novaMensagem").value.trim();
      if (!conteudo) return alert("⚠️ Digite algo para enviar.");

      fetch("/enviar_mensagem", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ conteudo })
      })
      .then(res => {
        if (res.ok) {
          document.getElementById("novaMensagem").value = "";
          carregarMensagens();
          alert("✅ Mensagem enviada!");
        } else {
          alert("❌ Erro ao enviar.");
        }
      });
    });

    function carregarMensagens() {
      fetch("/caixa_entrada")
        .then(res => res.json())
        .then(mensagens => {
          const lista = document.getElementById("listaMensagens");
          lista.innerHTML = mensagens.length
            ? mensagens.map(m => `
              <div class="mensagem ${m.autor == "{{ current_user.username }}" ? "usuario-atual" : "outros-usuario"}" id="mensagem-${m.id}">
                <strong >${m.autor}</strong>: <span>${m.conteudo}</span>
                <small>${m.data}</small>
                ${m.autor == "{{ current_user.username }}" ? `<button class="btnExcluir" data-id="${m.id}">❌</button>` : ""}
              </div>`).join('')
            : "<p style='text-align:center;'>📭 Nenhuma mensagem recebida.</p>";

          document.querySelectorAll(".btnExcluir").forEach(btn => {
            btn.addEventListener("click", e => {
              const id = e.target.dataset.id;
              if (confirm("Excluir esta mensagem?")) {
                fetch(`/excluir_mensagem/${id}`, { method: "DELETE" })
                  .then(res => {
                    if (res.ok) {
                      document.getElementById(`mensagem-${id}`)?.remove();
                      alert("✅ Mensagem excluída!");
                    }
                  });
              }
            });
          });
        });
    }

    // 📅 Modal Calendário
    document.querySelectorAll(".btnCalendario").forEach(btn => {
      btn.addEventListener("click", () => {
        musicaSelecionada = btn.dataset.id;
        document.getElementById("modalCalendario").style.display = "flex";
        document.getElementById("inputDataEnsaio").focus();
      });
    });

    document.getElementById("fecharModal").addEventListener("click", () => {
      document.getElementById("modalCalendario").style.display = "none";
    });

    document.getElementById("btnSalvarData").addEventListener("click", () => {
      const dataSelecionada = document.getElementById("inputDataEnsaio").value;
      if (!dataSelecionada || !musicaSelecionada) {
        alert("⚠️ Selecione uma data válida!");
        return;
      }

      fetch(`/salvar_data_ensaio/${musicaSelecionada}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data_ensaio: dataSelecionada })
      })
      .then(res => res.json())
      .then(() => {
        const botao = document.querySelector(`.btnCalendario[data-id='${musicaSelecionada}']`);
        if (botao) {
          const [ano, mes, dia] = dataSelecionada.split("-");
          botao.textContent = `📅 ${dia}/${mes}/${ano}`;
        }
        document.getElementById("modalCalendario").style.display = "none";
        alert("✅ Data salva com sucesso!");
      })
      .catch(() => alert("❌ Erro ao salvar a data."));
    });

    // 🔄 Atualizar status ensaiadas
  document.querySelectorAll('input[type="checkbox"][name^="status_"]').forEach(checkbox => {
    checkbox.addEventListener("change", () => {
      const musicaId = checkbox.name.split("_")[1];
      const status = checkbox.checked;

      fetch(`/atualizar_status_musica/${musicaId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ensaiada: status })
      })
      .then(res => res.json())
      .then(data => {
        // Atualiza botão 📅 caso necessário
        const botao = document.querySelector(`.btnCalendario[data-id='${musicaId}']`);
        if (botao) botao.textContent = `📅 ${data.data_ensaio || ""}`;

        // Opcional: atualizar listas “Ensaiadas” e “A Ensaiar” se estiverem na tela
        location.reload(); // ou uma função que remonte só as listas sem reload
      })
      .catch(() => alert("❌ Erro ao atualizar status."));
    });
  });



    // Fechar modais clicando fora
    window.addEventListener("click", e => {
      if (e.target.classList.contains("modal-mensagens")) {
        document.getElementById("modalMensagens").style.display = "none";
      }
      if (e.target.classList.contains("modal-calendario")) {
        document.getElementById("modalCalendario").style.display = "none";
      }
    });

    // Proteção ao voltar com F5/cache
    window.onpageshow = function (event) {
      if (event.persisted || performance.navigation.type === 2) {
        history.replaceState(null, "", "{{ url_for('logout') }}");
        window.location.href = "{{ url_for('logout') }}";
      }
    };
  </script>


  <script>
    function imprimirCard(botao) {
      const card = botao.closest('.card-musica');
      const janela = window.open('', '', 'width=800,height=600');
      janela.document.write('<html><head><title>Imprimir Card</title></head><body>');
      janela.document.write(card.innerHTML);
      janela.document.write('</body></html>');
      janela.document.close();
      janela.print();
  }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    function imprimirMusicas() {
      const area = document.getElementById('area-impressao');
      if (!area) {
        alert("Não há músicas disponíveis para impressão.");
        return;
      }

      const estilo = `
        <style>
          body {
            font-family: Arial, sans-serif;
            padding: 30px;
            background-color: #fff;
            color: #222;
          }
          h1 {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
          }
          h2 {
            font-size: 20px;
            margin-top: 30px;
            color: #2c3e50;
          }
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
          }
          th, td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: left;
          }
          th {
            background-color: #f0f0f0;
          }
          tr:nth-child(even) {
            background-color: #f9f9f9;
          }
        </style>
      `;

      const janela = window.open('', '', 'width=800,height=600');
      janela.document.write('<html><head><title>Repertório de Músicas</title>' + estilo + '</head><body>');
      janela.document.write('<h1>Repertório de Músicas</h1>');
      janela.document.write(area.innerHTML);
      janela.document.write('</body></html>');
      janela.document.close();
      janela.focus();
      janela.print();
    }
  </script>


      <!-- Modal de Adicionar Música -->
    <div id="modalAdicionarMusica" class="modal-adicionar" style="display: none;">
      <div class="modal-content">
        <button id="fecharModalAdicionarMusica" class="fechar-modal" aria-label="Fechar">
          <i class="fa-solid fa-xmark"></i>
        </button>
        <div class="container-adicionar">
          <h2>Adicionar Nova Música</h2>
          <form action="{{ url_for('musicas') }}" method="POST" class="formulario">
            <label>Título:</label>
            <input type="text" name="titulo" required />
            <label>Autor:</label>
            <input type="text" name="autor" required />
            <label>Gênero:</label>
            <input type="text" name="genero" required />
            <label for="tom">Tom da Música:</label>
            <select id="tom" name="tom" required>
              <option value="" disabled selected>Selecione um tom</option>
              <option value="C">Dó (C)</option>
              <option value="C#">Dó# (C#)</option>
              <option value="D">Ré (D)</option>
              <option value="D#">Ré# (D#)</option>
              <option value="E">Mi (E)</option>
              <option value="F">Fá (F)</option>
              <option value="F#">Fá# (F#)</option>
              <option value="G">Sol (G)</option>
              <option value="G#">Sol# (G#)</option>
              <option value="A">Lá (A)</option>
              <option value="A#">Lá# (A#)</option>
              <option value="B">Si (B)</option>
            </select>
            <label><input type="checkbox" name="ensaiada" /> Ensaiada</label>
            <button type="submit" class="botao-adicionar">
              <i class="fa-solid fa-plus"></i> Adicionar Música
            </button>
          </form>
        </div>
      </div>
    </div>

  <footer class="rodape">
    <p>Sistema de Acompanhamento de Ensaios — Desenvolvido por Emanuel</p>
    <p>&copy; {{ current_year }} Todos os direitos reservados.</p>
    <div class="icones-sociais">
      <a href="https://www.instagram.com" target="_blank"><i class="fab fa-instagram"></i></a>
      <a href="https://www.facebook.com" target="_blank"><i class="fab fa-facebook-f"></i></a>
      <a href="https://www.youtube.com" target="_blank"><i class="fab fa-youtube"></i></a>
    </div>
  </footer>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const abrirBtn = document.getElementById("btnAbrirModalAdicionarMusica");
        const modal = document.getElementById("modalAdicionarMusica");
        const fecharBtn = document.getElementById("fecharModalAdicionarMusica");

        if (abrirBtn && modal && fecharBtn) {
          abrirBtn.addEventListener("click", () => {
            modal.style.display = "flex";
          });

          fecharBtn.addEventListener("click", () => {
            modal.style.display = "none";
          });

          window.addEventListener("click", e => {
            if (e.target === modal) {
              modal.style.display = "none";
            }
          });
        } else {
          console.warn("❌ Elementos do modal não encontrados.");
        }
      });

    function atualizarBlocosMusicas(musicaId, status) {
      const card = document.querySelector(`.card-musica[data-id='${musicaId}']`);
      if (!card) return;

      const blocoEnsaiadas = document.querySelector(".duas-listas .lista-cards:nth-child(1)");
      const blocoAEnsaiar = document.querySelector(".duas-listas .lista-cards:nth-child(2)");

      // Remove o card atual
      card.remove();

      // Recria o card com a nova classe
      const novoCard = document.createElement("div");
      novoCard.className = `card-musica ${status ? "ensaiada" : "a-ensaiar"}`;
      novoCard.setAttribute("data-id", musicaId);
      novoCard.innerHTML = card.innerHTML;

      // Insere no bloco correto
      if (status) {
        blocoEnsaiadas.appendChild(novoCard);
      } else {
        blocoAEnsaiar.appendChild(novoCard);
      }
    }
    </script>

    <script>
        document.getElementById("btnAbrirSolicitacoes")?.addEventListener("click", () => {
          const modal = document.getElementById("modalSolicitacoes");
          const lista = document.getElementById("listaSolicitacoes");
          modal.style.display = "flex";
          lista.innerHTML = "<p>🔄 Carregando solicitações...</p>";

          fetch("/listar_solicitacoes")
            .then(res => res.json())
            .then(listaUsuarios => {
              if (!listaUsuarios.length) {
                lista.innerHTML = "<p>📭 Nenhuma solicitação pendente.</p>";
                return;
              }

              lista.innerHTML = "";
              listaUsuarios.forEach(u => {
                lista.innerHTML += `
                  <div class="card p-3 mb-2" style="border: 1px solid #ccc; border-radius: 8px; padding: 10px;">
                    <strong>${u.nome} ${u.sobrenome}</strong> (${u.username})<br>
                    <small>Telefone: ${u.telefone}</small><br>
                    <button onclick="aprovar(${u.id})" class="btn btn-success mt-2">✅ Aprovar</button>
                    <button onclick="recusar(${u.id})" class="btn btn-danger mt-2">❌ Recusar</button>
                  </div>
                `;
              });
            });
        });

        document.getElementById("fecharSolicitacoes").addEventListener("click", () => {
          document.getElementById("modalSolicitacoes").style.display = "none";
        });

        function aprovar(id) {
          fetch(`/aprovar_usuario/${id}`, { method: "POST" })
            .then(res => res.json())
            .then(() => {
              alert("✅ Solicitação aprovada!");
              document.getElementById("btnAbrirSolicitacoes").click(); // recarrega
            });
        }

        function recusar(id) {
          if (!confirm("Tem certeza que deseja recusar esta solicitação?")) return;
          fetch(`/recusar_usuario/${id}`, { method: "POST" })
            .then(res => res.json())
            .then(() => {
              alert("❌ Solicitação recusada.");
              document.getElementById("btnAbrirSolicitacoes").click(); // recarrega
            });
        }
    </script>

    
</body>
</html>