<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Usu√°rio - Acompanhamento de Ensaios</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='musicas.css') }}" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
  <style>
    @media print {
      .botao-voltar,
      .botao-adicionar,
      .acoes,
      .botao-imprimir,
      form,
      .mensagem-flash {
        display: none !important;
      }

      body * {
        visibility: hidden;
      }

      #area-impressao, #area-impressao * {
        visibility: visible;
      }

      #area-impressao {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>


  <header>
    <h1 class="efeito-aproximacao">üé∂ Ol√°, Bem-vindo(a) {{ current_user.username }}</h1>
  </header>

  <div class="botoes-wrapper">
    <a href="{{ url_for('escala') }}" class="botao-escala"><i class="fa-solid fa-calendar-alt"></i> Ir para Escalas</a>
    {% if current_user.role == "admin" %}
    <a href="{{ url_for('gerenciar_usuarios') }}" class="botao-gerenciar"><i class="fa-solid fa-users"></i> Gerenciar Usu√°rios</a>
    {% endif %}
    <a href="{{ url_for('cultos') }}" class="botao-ver-cultos">üìñ Ver Cultos Agendados</a>
    <button id="btnAbrirMensagens" class="botao-mensagens">üí¨ Mensagens</button>
    <a href="{{ url_for('logout') }}" class="botao-sair"><i class="fas fa-sign-out-alt"></i> Sair</a>
  </div>



  <!-- Modal de Mensagens -->
  <div id="modalMensagens" class="modal-mensagens" style="display:none;">
    <div class="modal-content">
      <span class="close" id="fecharMensagens">&times;</span>
      <h3>üì© Caixa de Entrada</h3>
      <div id="listaMensagens"></div>
      <textarea id="novaMensagem" placeholder="Digite sua mensagem..."></textarea>
      <button id="btnEnviarMensagem">‚úâÔ∏è Enviar</button>
    </div>
  </div>

  <!-- Modal de Calend√°rio -->
  <div id="modalCalendario" class="modal-calendario" style="display:none;">
    <div class="modal-content">
      <span class="close" id="fecharModal">&times;</span>
      <h3>üìÖ Selecionar Data de Ensaio</h3>
      <input type="date" id="inputDataEnsaio">
      <button id="btnSalvarData">‚úÖ Salvar</button>
    </div>
  </div>



  <div id="cardMusicas">
    {% if musicas %}
      <form id="formMusicas">
        <table class="tabela">
          <thead>
            <tr>
              <th>T√≠tulo</th>
              <th>Autor</th>
              <th>Tom</th>
              <th>G√™nero</th>
              <th>Ensaiada?</th>
              {% if current_user.role in ["cantor", "admin"] %}
                <th>A√ß√£o</th>
                <th>Data do Ensaio</th>
              {% endif %}
            </tr>
          </thead>
          <tbody id="tabelaMusicas">
            {% for musica in musicas %}
            <tr>
              <td>{{ musica.titulo }}</td>
              <td>{{ musica.autor }}</td>
              <td>{{ musica.tom }}</td>
              <td>{{ musica.genero }}</td>
              <td>
                <input type="checkbox" name="status_{{ musica.musica_id }}" {% if musica.ensaiada %}checked{% endif %}>
              </td>
              {% if current_user.role in ["cantor", "admin"] %}
              <td>
                <form method="POST" action="{{ url_for('excluir_musica', musica_id=musica.musica_id) }}">
                  <button type="submit" class="botao-excluir">‚ùå Excluir</button>
                </form>
              </td>
              <td>
                <button type="button" class="btnCalendario" data-id="{{ musica.musica_id }}">
                  üìÖ {{ musica.data_ensaio.strftime('%d/%m/%Y') if musica.data_ensaio else '' }}
                </button>
              </td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>

        {% if musicas %}
          <div id="area-impressao" style="display: none;">
            <h2>üéº M√∫sicas Ensaiadas</h2>
            <table>
              <thead>
                <tr>
                  <th>T√≠tulo</th>
                  <th>Autor</th>
                  <th>Tom</th>
                </tr>
              </thead>
              <tbody>
                {% for musica in musicas if musica.ensaiada %}
                <tr>
                  <td>{{ musica.titulo }}</td>
                  <td>{{ musica.autor }}</td>
                  <td>{{ musica.tom }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            <h2 style="margin-top: 40px;">üéØ M√∫sicas a Ensaiar</h2>
            <table>
              <thead>
                <tr>
                  <th>T√≠tulo</th>
                  <th>Autor</th>
                  <th>Tom</th>
                </tr>
              </thead>
              <tbody>
                {% for musica in musicas if not musica.ensaiada %}
                <tr>
                  <td>{{ musica.titulo }}</td>
                  <td>{{ musica.autor }}</td>
                  <td>{{ musica.tom }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}

        
        

        <div class="centraliza-botao-wrapper">
          <button id="btnAbrirModalAdicionarMusica" class="botao-adicionar-musica" type="button">
            ‚ûï Adicionar Nova M√∫sica
          </button>
        </div>
      </form>

      <div class="main-container">
        <h2>M√∫sicas Ensaiadas</h2>
        <ul>
          {% for musica in musicas %}
            {% if musica.ensaiada %}
            <li>
              <strong>{{ musica.titulo }}</strong>
              <span class="info-extra">‚Äî {{ musica.autor }} | Tom: {{ musica.tom }}</span>
            </li>
            {% endif %}
          {% endfor %}
        </ul>

        <h2>M√∫sicas a Ensaiar</h2>
        <ul>
          {% for musica in musicas %}
            {% if not musica.ensaiada %}
            <li>
              <strong>{{ musica.titulo }}</strong>
              <span class="info-extra">‚Äî {{ musica.autor }} | Tom: {{ musica.tom }}</span>
            </li>
            {% endif %}
          {% endfor %}
        </ul>

        <div style="margin-top: 20px;">
          <button onclick="imprimirMusicas()" type="button" class="botao-imprimir">üñ®Ô∏è Imprimir M√∫sicas</button>
        </div>

    {% else %}
      <p>üìå Nenhuma m√∫sica cadastrada no momento.</p>
    {% endif %}
  </div>
  </form>


<!-- Modal de Adicionar M√∫sica -->
    <div id="modalAdicionarMusica" class="modal-adicionar" style="display: none;">
      <div class="modal-content">
        <span class="close" id="fecharModalAdicionarMusica">&times;</span>
        <div class="container-adicionar">
          <h2>Adicionar Nova M√∫sica</h2>
          <form action="{{ url_for('musicas') }}" method="POST" class="formulario">
            <label>T√≠tulo:</label>
            <input type="text" name="titulo" required />
            <label>Autor:</label>
            <input type="text" name="autor" required />
            <label>G√™nero:</label>
            <input type="text" name="genero" required />
            <label for="tom">Tom da M√∫sica:</label>
            <select id="tom" name="tom" required>
              <option value="" disabled selected>Selecione um tom</option>
              <option value="C">D√≥ (C)</option>
              <option value="C#">D√≥# (C#)</option>
              <option value="D">R√© (D)</option>
              <option value="D#">R√©# (D#)</option>
              <option value="E">Mi (E)</option>
              <option value="F">F√° (F)</option>
              <option value="F#">F√°# (F#)</option>
              <option value="G">Sol (G)</option>
              <option value="G#">Sol# (G#)</option>
              <option value="A">L√° (A)</option>
              <option value="A#">L√°# (A#)</option>
              <option value="B">Si (B)</option>
            </select>
            <label><input type="checkbox" name="ensaiada" /> Ensaiada</label>
            <button type="submit" class="botao-adicionar">
              <i class="fa-solid fa-plus"></i> Adicionar M√∫sica
            </button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <script>
    let musicaSelecionada = null;

    // üì© Mensagens
    document.getElementById("btnAbrirMensagens").addEventListener("click", () => {
      document.getElementById("modalMensagens").style.display = "block";
      carregarMensagens();
    });

    document.getElementById("fecharMensagens").addEventListener("click", () => {
      document.getElementById("modalMensagens").style.display = "none";
    });

    document.getElementById("btnEnviarMensagem").addEventListener("click", () => {
      const conteudo = document.getElementById("novaMensagem").value.trim();
      if (!conteudo) return alert("‚ö†Ô∏è Digite algo para enviar.");

      fetch("/enviar_mensagem", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ conteudo })
      })
      .then(res => {
        if (res.ok) {
          document.getElementById("novaMensagem").value = "";
          carregarMensagens();
          alert("‚úÖ Mensagem enviada!");
        } else {
          alert("‚ùå Erro ao enviar.");
        }
      });
    });

    function carregarMensagens() {
      fetch("/caixa_entrada")
        .then(res => res.json())
        .then(mensagens => {
          const lista = document.getElementById("listaMensagens");
          lista.innerHTML = mensagens.length
            ? mensagens.map(m => `
              <div class="mensagem ${m.autor == "{{ current_user.username }}" ? "usuario-atual" : "outros-usuario"}" id="mensagem-${m.id}">
                <strong >${m.autor}</strong>: <span>${m.conteudo}</span>
                <small>${m.data}</small>
                ${m.autor == "{{ current_user.username }}" ? `<button class="btnExcluir" data-id="${m.id}">‚ùå</button>` : ""}
              </div>`).join('')
            : "<p style='text-align:center;'>üì≠ Nenhuma mensagem recebida.</p>";

          document.querySelectorAll(".btnExcluir").forEach(btn => {
            btn.addEventListener("click", e => {
              const id = e.target.dataset.id;
              if (confirm("Excluir esta mensagem?")) {
                fetch(`/excluir_mensagem/${id}`, { method: "DELETE" })
                  .then(res => {
                    if (res.ok) {
                      document.getElementById(`mensagem-${id}`)?.remove();
                      alert("‚úÖ Mensagem exclu√≠da!");
                    }
                  });
              }
            });
          });
        });
    }

    // üìÖ Modal Calend√°rio
    document.querySelectorAll(".btnCalendario").forEach(btn => {
      btn.addEventListener("click", () => {
        musicaSelecionada = btn.dataset.id;
        document.getElementById("modalCalendario").style.display = "flex";
        document.getElementById("inputDataEnsaio").focus();
      });
    });

    document.getElementById("fecharModal").addEventListener("click", () => {
      document.getElementById("modalCalendario").style.display = "none";
    });

    document.getElementById("btnSalvarData").addEventListener("click", () => {
      const dataSelecionada = document.getElementById("inputDataEnsaio").value;
      if (!dataSelecionada || !musicaSelecionada) {
        alert("‚ö†Ô∏è Selecione uma data v√°lida!");
        return;
      }

      fetch(`/salvar_data_ensaio/${musicaSelecionada}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data_ensaio: dataSelecionada })
      })
      .then(res => res.json())
      .then(() => {
        const botao = document.querySelector(`.btnCalendario[data-id='${musicaSelecionada}']`);
        if (botao) {
          const [ano, mes, dia] = dataSelecionada.split("-");
          botao.textContent = `üìÖ ${dia}/${mes}/${ano}`;
        }
        document.getElementById("modalCalendario").style.display = "none";
        alert("‚úÖ Data salva com sucesso!");
      })
      .catch(() => alert("‚ùå Erro ao salvar a data."));
    });

    // üîÑ Atualizar status ensaiadas
  document.querySelectorAll('input[type="checkbox"][name^="status_"]').forEach(checkbox => {
    checkbox.addEventListener("change", () => {
      const musicaId = checkbox.name.split("_")[1];
      const status = checkbox.checked;

      fetch(`/atualizar_status_musica/${musicaId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ensaiada: status })
      })
      .then(res => res.json())
      .then(data => {
        // Atualiza bot√£o üìÖ caso necess√°rio
        const botao = document.querySelector(`.btnCalendario[data-id='${musicaId}']`);
        if (botao) botao.textContent = `üìÖ ${data.data_ensaio || ""}`;

        // Opcional: atualizar listas ‚ÄúEnsaiadas‚Äù e ‚ÄúA Ensaiar‚Äù se estiverem na tela
        location.reload(); // ou uma fun√ß√£o que remonte s√≥ as listas sem reload
      })
      .catch(() => alert("‚ùå Erro ao atualizar status."));
    });
  });



    // Fechar modais clicando fora
    window.addEventListener("click", e => {
      if (e.target.classList.contains("modal-mensagens")) {
        document.getElementById("modalMensagens").style.display = "none";
      }
      if (e.target.classList.contains("modal-calendario")) {
        document.getElementById("modalCalendario").style.display = "none";
      }
    });

    // Prote√ß√£o ao voltar com F5/cache
    window.onpageshow = function (event) {
      if (event.persisted || performance.navigation.type === 2) {
        history.replaceState(null, "", "{{ url_for('logout') }}");
        window.location.href = "{{ url_for('logout') }}";
      }
    };
  </script>
  <!-- Modal: Adicionar Nova M√∫sica -->
  <script>
    document.getElementById("btnAbrirModalAdicionarMusica").addEventListener("click", () => {
      document.getElementById("modalAdicionarMusica").style.display = "flex";
    });

    document.getElementById("fecharModalAdicionarMusica").addEventListener("click", () => {
      document.getElementById("modalAdicionarMusica").style.display = "none";
    });

    window.addEventListener("click", e => {
      if (e.target.id === "modalAdicionarMusica") {
        document.getElementById("modalAdicionarMusica").style.display = "none";
      }
    });
  </script>

  <script>
    function imprimirCard(botao) {
      const card = botao.closest('.card-musica');
      const janela = window.open('', '', 'width=800,height=600');
      janela.document.write('<html><head><title>Imprimir Card</title></head><body>');
      janela.document.write(card.innerHTML);
      janela.document.write('</body></html>');
      janela.document.close();
      janela.print();
  }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    function imprimirMusicas() {
      const area = document.getElementById('area-impressao');
      if (!area) {
        alert("N√£o h√° m√∫sicas dispon√≠veis para impress√£o.");
        return;
      }

      const estilo = `
        <style>
          body {
            font-family: Arial, sans-serif;
            padding: 30px;
            background-color: #fff;
            color: #222;
          }
          h1 {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
          }
          h2 {
            font-size: 20px;
            margin-top: 30px;
            color: #2c3e50;
          }
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
          }
          th, td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: left;
          }
          th {
            background-color: #f0f0f0;
          }
          tr:nth-child(even) {
            background-color: #f9f9f9;
          }
        </style>
      `;

      const janela = window.open('', '', 'width=800,height=600');
      janela.document.write('<html><head><title>Repert√≥rio de M√∫sicas</title>' + estilo + '</head><body>');
      janela.document.write('<h1>Repert√≥rio de M√∫sicas</h1>');
      janela.document.write(area.innerHTML);
      janela.document.write('</body></html>');
      janela.document.close();
      janela.focus();
      janela.print();
    }
  </script>

  <footer class="rodape">
    <p>Sistema de Acompanhamento de Ensaios ‚Äî Desenvolvido por Emanuel</p>
    <p>&copy; {{ current_year }} Todos os direitos reservados.</p>
    <div class="icones-sociais">
      <a href="https://www.instagram.com" target="_blank"><i class="fab fa-instagram"></i></a>
      <a href="https://www.facebook.com" target="_blank"><i class="fab fa-facebook-f"></i></a>
      <a href="https://www.youtube.com" target="_blank"><i class="fab fa-youtube"></i></a>
    </div>
  </footer>
</body>
</html>