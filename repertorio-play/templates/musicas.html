<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Usu√°rio - Acompanhamento de Ensaios</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='musicas.css') }}" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
  <style>
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modal-conteudo {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      position: relative;
    }

    .fechar-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <button class="botao-fechar-sessao" onclick="window.location.href='{{ url_for('logout') }}'" title="Sair">
    &times;
  </button>

  <header>
    <div class="logo-central mb-3">
      <img src="{{ url_for('static', filename='imagens/logo.png') }}" alt="Logo_Play_Repert√≥rio" />
      <h1 class="mb-3 fs-4 fs-md-3">Bem-vindo, {{ current_user.nome }}!</h1>
    </div>
  </header>

<div class="botoes-wrapper">
  <a href="{{ url_for('escala') }}" class="botao-padrao"><i class="fa-solid fa-calendar-alt"></i> Ir para Escalas</a>
  <a href="{{ url_for('gerenciar_usuarios') }}" class="botao-padrao"><i class="fa-solid fa-users"></i> Gerenciar Usu√°rios</a>
  <button id="btnAbrirSolicitacoes" class="botao-padrao">üë• Ver solicita√ß√µes de cadastro</button>
  <a href="{{ url_for('cultos') }}" class="botao-padrao">üìñ Ver Cultos Agendados</a>
  <button onclick="imprimirMusicas()" type="button" class="botao-padrao">üñ®Ô∏è Imprimir M√∫sicas</button>
  <button id="btnAbrirMensagens" class="botao-padrao">üí¨ Mensagens</button>
</div>

<!-- Modal de Mensagens -->
<div id="modalMensagens" class="modal-mensagens" style="display:none;">
  <div class="modal-content">
    <span class="close" id="fecharMensagens">&times;</span>
    <h3>üì© Caixa de Entrada</h3>
    <div id="listaMensagens">
      <!-- Exemplo de mensagem -->
      <div class="mensagem-item">
        <span class="usuario">Emanuel:</span>
        <span class="texto">Essa m√∫sica j√° foi ensaiada com o grupo.</span>
      </div>
    </div>
    <textarea id="novaMensagem" placeholder="Digite sua mensagem..."></textarea>
    <button id="btnEnviarMensagem">‚úâÔ∏è Enviar</button>
  </div>
</div>

<!-- Modal de Solicita√ß√µes de Cadastro -->
<div id="modalSolicitacoes" class="modal-solicitacoes" style="display:none;">
  <div class="modal-content">
    <span class="close" id="fecharSolicitacoes">&times;</span>
    <h3>Solicita√ß√µes de Cadastro</h3>
    <div id="listaSolicitacoes">
      <p>üîÑ Carregando solicita√ß√µes...</p>
    </div>
  </div>
</div>

<!-- Modal de Calend√°rio -->
<div id="modalCalendario" class="modal-calendario" style="display:none;">
  <div class="modal-content">
    <span class="close" id="fecharModal">&times;</span>
    <h3>üìÖ Selecionar Data de Ensaio</h3>
    <input type="date" id="inputDataEnsaio">
    <button id="btnSalvarData">‚úÖ Salvar</button>
  </div>
</div>

<div id="cardMusicas">
  {% if musicas %}
    <form id="formMusicas"></form>

    <div class="tabela-container">
      <table class="tabela">
        <thead>
          <tr>
            <th>T√≠tulo</th>
            <th>Autor</th>
            <th>Tom</th>
            <th>G√™nero</th>
            <th>Ensaiada?</th>
            {% if current_user.role in ["cantor", "admin"] %}
              <th>A√ß√£o</th>
              <th>Data do Ensaio</th>
            {% endif %}
            <th>Adicionada por</th>
            <th>V√≠deo</th>
          </tr>
        </thead>
        <tbody id="tabelaMusicas">
          {% for musica in musicas %}
          <tr>
            <td>{{ musica.titulo }}</td>
            <td>{{ musica.autor }}</td>
            <td>{{ musica.tom }}</td>
            <td>{{ musica.genero }}</td>
            <td>
              <input type="checkbox" name="status_{{ musica.musica_id }}" {% if musica.ensaiada %}checked{% endif %}>
            </td>
            {% if current_user.role in ["cantor", "admin"] %}
            <td>
              <form action="{{ url_for('excluir_musica', musica_id=musica.musica_id) }}" method="POST">
                <button type="submit" class="botao-excluir">‚ùå Excluir</button>
              </form>
            </td>
            <td>
              <button type="button" class="btnCalendario" data-id="{{ musica.musica_id }}">
                üìÖ {{ musica.data_ensaio.strftime('%d/%m/%Y') if musica.data_ensaio else '' }}
              </button>
            </td>
            {% endif %}
            <td>{{ musica.usuario.nome if musica.usuario else "Desconhecido" }}</td>
            <td>
              {% if musica.link_youtube %}
                üé¨ V√≠deo dispon√≠vel
              {% else %}
                ‚Äî
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="area-impressao" style="display: none;">
      <h2>üéº M√∫sicas Ensaiadas</h2>
      {% set ensaiadas = musicas | selectattr("ensaiada") | list %}
      {% if ensaiadas %}
        <table class="tabela">
          <thead>
            <tr><th>T√≠tulo</th><th>Autor</th><th>Tom</th></tr>
          </thead>
          <tbody>
            {% for musica in ensaiadas %}
            <tr>
              <td>{{ musica.titulo }}</td>
              <td>{{ musica.autor }}</td>
              <td>{{ musica.tom }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p style="padding: 10px;">üì≠ Nenhuma m√∫sica ensaiada.</p>
      {% endif %}

      <h2 style="margin-top: 40px;">üéØ M√∫sicas a Ensaiar</h2>
      {% set a_ensaiar = musicas | rejectattr("ensaiada") | list %}
      {% if a_ensaiar %}
        <table class="tabela">
          <thead>
            <tr><th>T√≠tulo</th><th>Autor</th><th>Tom</th></tr>
          </thead>
          <tbody>
            {% for musica in a_ensaiar %}
            <tr>
              <td>{{ musica.titulo }}</td>
              <td>{{ musica.autor }}</td>
              <td>{{ musica.tom }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p style="padding: 10px;">üì≠ Nenhuma m√∫sica pendente de ensaio.</p>
      {% endif %}
    </div>
  {% else %}
    <p>üìå Nenhuma m√∫sica cadastrada no momento.</p>
  {% endif %}
</div>

<div class="centraliza-botao-wrapper">
  <button id="btnAbrirModalAdicionarMusica" class="botao-adicionar-musica" type="button">
    ‚ûï Adicionar Nova M√∫sica
  </button>
</div>


<div class="duas-listas">
  <!-- Bloco: M√∫sicas Ensaiadas -->
  <div class="lista-cards">
    <h2>üéº M√∫sicas Ensaiadas</h2>
    {% for musica in musicas %}
      {% if musica.ensaiada %}
      <div class="card-musica ensaiada" data-id="{{ musica.musica_id }}">
        <div class="card-header">
          <i class="fa-solid fa-check-circle"></i>
          <strong>{{ musica.titulo }}</strong>
        </div>
        <div class="card-body">
          <p><strong>Autor:</strong> {{ musica.autor }}</p>
          <p><strong>Tom:</strong> {{ musica.tom }}</p>
          {% if musica.link_youtube %}
            <a href="{{ musica.link_youtube }}" target="_blank" rel="noopener" class="botao-video">
              üé¨ Ver v√≠deo
            </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    {% endfor %}
  </div>

  <!-- Bloco: M√∫sicas a Ensaiar -->
<div class="lista-cards">
  <h2>üéØ M√∫sicas a Ensaiar</h2>
  {% for musica in musicas %}
    {% if not musica.ensaiada %}
    <div class="card-musica a-ensaiar" data-id="{{ musica.musica_id }}">
      <div class="card-header">
        <i class="fa-solid fa-music"></i>
        <strong>{{ musica.titulo }}</strong>
      </div>
      <div class="card-body">
        <p><strong>Autor:</strong> {{ musica.autor }}</p>
        <p><strong>Tom:</strong> {{ musica.tom }}</p>
        {% if musica.link_youtube %}
          <a href="{{ musica.link_youtube }}" target="_blank" rel="noopener">
            <button>üé¨ Ver v√≠deo</button>
          </a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  {% endfor %}
</div>


<!-- Modal de V√≠deo do YouTube -->
<div id="modal-video" class="modal" style="display: none;">
  <div class="modal-conteudo">
    <span class="fechar-modal">&times;</span>
    <iframe
      id="iframe-video"
      width="100%"
      height="315"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen
      sandbox="allow-scripts allow-same-origin">
   </iframe>
  </div>
</div>

<!-- Script para abrir e fechar o modal -->



<!-- Scripts de mensagens -->
<script>
  document.getElementById("btnAbrirMensagens").addEventListener("click", () => {
    document.getElementById("modalMensagens").style.display = "block";
    carregarMensagens();
  });

  document.getElementById("fecharMensagens").addEventListener("click", () => {
    document.getElementById("modalMensagens").style.display = "none";
  });

  document.getElementById("btnEnviarMensagem").addEventListener("click", () => {
    const conteudo = document.getElementById("novaMensagem").value.trim();
    if (!conteudo) return alert("‚ö†Ô∏è Digite algo para enviar.");

    fetch("/enviar_mensagem", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ conteudo })
    })
    .then(res => {
      if (res.ok) {
        document.getElementById("novaMensagem").value = "";
        carregarMensagens();
        alert("‚úÖ Mensagem enviada!");
      } else {
        alert("‚ùå Erro ao enviar.");
      }
    });
  });

  function carregarMensagens() {
    fetch("/caixa_entrada")
      .then(res => res.json())
      .then(mensagens => {
        const lista = document.getElementById("listaMensagens");
        lista.innerHTML = mensagens.length
          ? mensagens.map(m => `
            <div class="mensagem" id="mensagem-${m.id}">
              <strong>${m.autor}</strong>: <span>${m.conteudo}</span>
              <small>${m.data}</small>
              ${m.autor == "{{ current_user.username }}" ? `<button class="btnExcluir" data-id="${m.id}">‚ùå</button>` : ""}
            </div>`).join('')
          : "<p style='text-align:center;'>üì≠ Nenhuma mensagem recebida.</p>";

        document.querySelectorAll(".btnExcluir").forEach(btn => {
          btn.addEventListener("click", e => {
            const id = e.target.dataset.id;
            if (confirm("Excluir esta mensagem?")) {
              fetch(`/excluir_mensagem/${id}`, { method: "DELETE" })
                .then(res => {
                  if (res.ok) {
                    document.getElementById(`mensagem-${id}`)?.remove();
                    alert("‚úÖ Mensagem exclu√≠da!");
                  }
                });
            }
          });
        });
      });
  }
</script>

<!-- Scripts de calend√°rio -->
<script>
  let musicaSelecionada = null;

  document.querySelectorAll(".btnCalendario").forEach(btn => {
    btn.addEventListener("click", () => {
      musicaSelecionada = btn.dataset.id;
      document.getElementById("modalCalendario").style.display = "flex";
      document.getElementById("inputDataEnsaio").focus();
    });
  });

  document.getElementById("fecharModal").addEventListener("click", () => {
    document.getElementById("modalCalendario").style.display = "none";
  });

  document.getElementById("btnSalvarData").addEventListener("click", () => {
    const dataSelecionada = document.getElementById("inputDataEnsaio").value;
    if (!dataSelecionada || !musicaSelecionada) {
      alert("‚ö†Ô∏è Selecione uma data v√°lida!");
      return;
    }

    fetch(`/salvar_data_ensaio/${musicaSelecionada}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data_ensaio: dataSelecionada })
    })
    .then(res => res.json())
    .then(() => {
      const botao = document.querySelector(`.btnCalendario[data-id='${musicaSelecionada}']`);
      if (botao) {
        const [ano, mes, dia] = dataSelecionada.split("-");
        botao.textContent = `üìÖ ${dia}/${mes}/${ano}`;
      }
      document.getElementById("modalCalendario").style.display = "none";
      alert("‚úÖ Data salva com sucesso!");
    })
    .catch(() => alert("‚ùå Erro ao salvar a data."));
  });
</script>

<!-- Scripts de status -->
<script>
  document.querySelectorAll('input[type="checkbox"][name^="status_"]').forEach(checkbox => {
    checkbox.addEventListener("change", () => {
      const musicaId = checkbox.name.split("_")[1];
      const status = checkbox.checked;

      fetch(`/atualizar_status_musica/${musicaId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ensaiada: status })
      })
      .then(res => res.json())
      .then(data => {
        const botao = document.querySelector(`.btnCalendario[data-id='${musicaId}']`);
        if (botao) botao.textContent = `üìÖ ${data.data_ensaio || ""}`;
        atualizarBlocosMusicas(musicaId, status);
      })
      .catch(() => alert("‚ùå Erro ao atualizar status."));
    });
  });

  function atualizarBlocosMusicas(musicaId, status) {
    const card = document.querySelector(`.card-musica[data-id='${musicaId}']`);
    if (!card) return;

    const blocoEnsaiadas = document.querySelector(".duas-listas .lista-cards:nth-child(1)");
    const blocoAEnsaiar = document.querySelector(".duas-listas .lista-cards:nth-child(2)");

    card.remove();

    const novoCard = document.createElement("div");
    novoCard.className = `card-musica ${status ? "ensaiada" : "a-ensaiar"}`;
    novoCard.setAttribute("data-id", musicaId);
    novoCard.innerHTML = card.innerHTML;

    if (status) {
      blocoEnsaiadas.appendChild(novoCard);
    } else {
      blocoAEnsaiar.appendChild(novoCard);
    }
  }
</script>

<!-- Scripts de impress√£o -->
<script>
  function imprimirMusicas() {
    const area = document.getElementById('area-impressao');
    if (!area) {
      alert("N√£o h√° m√∫sicas dispon√≠veis para impress√£o.");
      return;
    }

    const estilo = `
      <style>
        body {
          font-family: Arial, sans-serif;
          padding: 30px;
          background-color: #fff;
          color: #222;
        }
        h1 {
          text-align: center;
          font-size: 24px;
          margin-bottom: 20px;
        }
        h2 {
          font-size: 20px;
          margin-top: 30px;
          color: #2c3e50;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 10px;
        }
        th, td {
          padding: 10px;
          border: 1px solid #ccc;
          text-align: left;
        }
        th {
          background-color: #f0f0f0;
        }
        tr:nth-child(even) {
          background-color: #f9f9f9;
        }
      </style>
    `;

    const janela = window.open('', '', 'width=800,height=600');
    janela.document.write('<html><head><title>Repert√≥rio de M√∫sicas</title>' + estilo + '</head><body>');
    janela.document.write('<h1>Repert√≥rio de M√∫sicas</h1>');
    janela.document.write(area.innerHTML);
    janela.document.write('</body></html>');
    janela.document.close();
    janela.focus();
    janela.print();
  }
</script>


<!-- Modal de Adicionar M√∫sica -->
<div id="modalAdicionarMusica" class="modal-adicionar" style="display: none;">
  <div class="modal-content">
    <button id="fecharModalAdicionarMusica" class="fechar-modal" aria-label="Fechar">
      <i class="fa-solid fa-xmark"></i>
    </button>
    <div class="container-adicionar">
      <h2>Adicionar Nova M√∫sica</h2>
      <form action="{{ url_for('musicas') }}" method="POST" class="formulario">
        <label>T√≠tulo:</label>
        <input type="text" name="titulo" required />
        <label>Autor:</label>
        <input type="text" name="autor" required />
        <label>G√™nero:</label>
        <input type="text" name="genero" required />
        <label for="tom">Tom da M√∫sica:</label>
        <select id="tom" name="tom" required>
          <option value="" disabled selected>Selecione um tom</option>
          <option value="C">D√≥ (C)</option>
          <option value="C#">D√≥# (C#)</option>
          <option value="D">R√© (D)</option>
          <option value="D#">R√©# (D#)</option>
          <option value="E">Mi (E)</option>
          <option value="F">F√° (F)</option>
          <option value="F#">F√°# (F#)</option>
          <option value="G">Sol (G)</option>
          <option value="G#">Sol# (G#)</option>
          <option value="A">L√° (A)</option>
          <option value="A#">L√°# (A#)</option>
          <option value="B">Si (B)</option>
        </select>
        <label><input type="checkbox" name="ensaiada" /> Ensaiada</label>
        <label for="link_youtube">Link do YouTube:</label>
        <input type="url" id="link_youtube" name="link_youtube" placeholder="https://www.youtube.com/watch?v=..." pattern="https://.*" />
        <button type="submit" class="botao-adicionar">
          <i class="fa-solid fa-plus"></i> Adicionar M√∫sica
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Script para abrir/fechar modal de adicionar m√∫sica -->
<script>
  document.getElementById("btnAbrirModalAdicionarMusica").addEventListener("click", () => {
    document.getElementById("modalAdicionarMusica").style.display = "flex";
  });

  document.getElementById("fecharModalAdicionarMusica").addEventListener("click", () => {
    document.getElementById("modalAdicionarMusica").style.display = "none";
  });

  window.addEventListener("click", (e) => {
    if (e.target === document.getElementById("modalAdicionarMusica")) {
      document.getElementById("modalAdicionarMusica").style.display = "none";
    }
  });
</script>

<script>
  document.getElementById("btnAbrirSolicitacoes").addEventListener("click", () => {
    document.getElementById("modalSolicitacoes").style.display = "block";
    carregarSolicitacoes();
  });

  document.getElementById("fecharSolicitacoes").addEventListener("click", () => {
    document.getElementById("modalSolicitacoes").style.display = "none";
  });

  function carregarSolicitacoes() {
    const lista = document.getElementById("listaSolicitacoes");
    lista.innerHTML = "<p>üîÑ Carregando solicita√ß√µes...</p>";

    fetch("/listar_solicitacoes")
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) {
          lista.innerHTML = "<p>‚úÖ Nenhuma solicita√ß√£o pendente.</p>";
          return;
        }

        lista.innerHTML = data.map(usuario => `
          <div class="solicitacao-item" style="margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
            <p><strong>${usuario.nome} ${usuario.sobrenome}</strong> (${usuario.username})</p>
            <p>üìû ${usuario.telefone}</p>
            <div style="display: flex; gap: 10px;">
              <button onclick="aprovarUsuario(${usuario.id})">‚úÖ Aprovar</button>
              <button onclick="recusarUsuario(${usuario.id})">üóëÔ∏è Recusar</button>
            </div>
          </div>
        `).join('');
      })
      .catch(() => {
        lista.innerHTML = "<p style='color:red;'>‚ùå Erro ao carregar solicita√ß√µes.</p>";
      });
  }

  function aprovarUsuario(id) {
    fetch(`/aprovar_usuario/${id}`, { method: "POST" })
      .then(res => res.json())
      .then(() => {
        alert("‚úÖ Usu√°rio aprovado!");
        carregarSolicitacoes();
      })
      .catch(() => alert("‚ùå Erro ao aprovar usu√°rio."));
  }

  function recusarUsuario(id) {
    fetch(`/recusar_usuario/${id}`, { method: "POST" })
      .then(res => res.json())
      .then(() => {
        alert("üóëÔ∏è Usu√°rio recusado.");
        carregarSolicitacoes();
      })
      .catch(() => alert("‚ùå Erro ao recusar usu√°rio."));
  }
</script>



</body>
</html>

